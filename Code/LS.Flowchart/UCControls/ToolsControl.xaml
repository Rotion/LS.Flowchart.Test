<UserControl
    x:Class="LS.Flowchart.UCControls.ToolsControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:LS.Flowchart.UCControls"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    d:DesignHeight="600"
    d:DesignWidth="300"
    Background="{DynamicResource DefaultBackground}"
    FontSize="20"
    Foreground="{DynamicResource DefaultForeground}"
    mc:Ignorable="d">
    <UserControl.Resources>
        <Style x:Key="RightAlignToggleStyle" TargetType="ToggleButton">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Grid>
                            <!--  默认状态图标（如向下箭头）  -->
                            <Path
                                x:Name="Arrow"
                                Width="30"
                                Height="30"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                Data="{DynamicResource 向右}"
                                Stroke="{DynamicResource DefaultForeground}" />
                        </Grid>
                        <ControlTemplate.Triggers>
                            <!--  展开时旋转图标（如向上箭头）  -->
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Arrow" Property="Data" Value="{DynamicResource 向上}" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>
    <ItemsControl x:Name="_itemCtrl" ItemsSource="{Binding Path=ItemSource, RelativeSource={RelativeSource AncestorType=UserControl}}">
        <ItemsControl.ItemTemplate>
            <DataTemplate>
                <Grid x:Name="_item_grid">
                    <Border
                        x:Name="_item_border"
                        Margin="2,0,2,0"
                        Background="Transparent"
                        BorderBrush="LightGray"
                        BorderThickness="0,0,0,1"
                        Opacity="0.3" />
                    <!--  手风琴效果  -->
                    <Grid x:Name="_folded">
                        <StackPanel
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Orientation="Vertical">
                            <Grid>
                                <!--  定义两列：左侧Header内容区 + 右侧图标  -->
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <!--  文字区域自适应  -->
                                    <ColumnDefinition Width="Auto" />
                                    <!--  图标固定右侧  -->
                                </Grid.ColumnDefinitions>

                                <!--  左侧Header内容  -->
                                <TextBlock
                                    Grid.Column="0"
                                    MinWidth="200"
                                    Margin="10,0,0,0"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Center"
                                    Text="{Binding Name}">
                                    <TextBlock.InputBindings>
                                        <MouseBinding
                                            Command="{Binding ItemClickCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            MouseAction="LeftClick" />
                                    </TextBlock.InputBindings>
                                </TextBlock>

                                <!--  右侧展开图标  -->
                                <Path
                                    x:Name="_path"
                                    Grid.Column="1"
                                    Width="15"
                                    Height="15"
                                    Margin="0,0,5,0"
                                    Data="{DynamicResource 向右}"
                                    Fill="{DynamicResource DefaultForeground}"
                                    Stretch="Uniform">
                                    <Path.InputBindings>
                                        <MouseBinding
                                            Command="{Binding ItemClickCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            MouseAction="LeftClick" />
                                    </Path.InputBindings>
                                </Path>

                                <Grid.InputBindings>
                                    <MouseBinding
                                        Command="{Binding ItemClickCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        MouseAction="LeftClick" />
                                </Grid.InputBindings>
                            </Grid>
                            <!--  内容区域  -->
                            <Grid x:Name="ExpandSite" Visibility="Visible">
                                <ItemsControl ItemsSource="{Binding ModuleItems}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <UniformGrid Columns="3" />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid
                                                x:Name="_ModuleItem_Bg"
                                                Margin="5"
                                                PreviewMouseDown="ModuleItem_MouseDown"
                                                PreviewMouseUp="ModuleItem_MouseUp">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="50" />
                                                    <RowDefinition Height="20" />
                                                </Grid.RowDefinitions>
                                                <Path
                                                    x:Name="_ModuleItem_Path"
                                                    Grid.Row="0"
                                                    Width="30"
                                                    Height="30"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    Data="{Binding Icon}"
                                                    Fill="{DynamicResource DefaultForeground}"
                                                    Stretch="Fill" />
                                                <TextBlock
                                                    x:Name="_ModuleItem_Text"
                                                    Grid.Row="1"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    FontSize="12"
                                                    Text="{Binding Name}" />
                                            </Grid>
                                            <DataTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="_ModuleItem_Bg" Property="Background" Value="Gray" />
                                                    <Setter TargetName="_ModuleItem_Path" Property="Fill" Value="{DynamicResource OrangeBrush}" />
                                                    <Setter TargetName="_ModuleItem_Text" Property="Foreground" Value="{DynamicResource OrangeBrush}" />
                                                    <Setter Property="Cursor" Value="SizeAll" />
                                                </Trigger>
                                            </DataTemplate.Triggers>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Grid>
                        </StackPanel>

                    </Grid>
                    <!--  收纳效果  -->
                    <Grid
                        x:Name="_keep"
                        MouseLeave="Path_MouseLeave"
                        PreviewMouseMove="Path_MouseOn"
                        Visibility="Collapsed">
                        <Path
                            x:Name="_keep_path"
                            Width="40"
                            Height="35"
                            Margin="10"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Data="{Binding Icon}"
                            Fill="{DynamicResource DefaultForeground}"
                            Stretch="Uniform"
                            Tag="{Binding Name}" />

                        <!--  悬浮弹窗  -->
                        <Popup
                            x:Name="expandPopup"
                            Width="220"
                            AllowsTransparency="True"
                            HorizontalOffset="20"
                            IsOpen="False"
                            MouseLeave="Popup_MouseLeave"
                            Placement="Right"
                            PlacementTarget="{Binding ElementName=_keep_path}"
                            PopupAnimation="Fade"
                            StaysOpen="True">
                            <Border
                                Background="{DynamicResource DefaultBackground}"
                                BorderBrush="{DynamicResource OrangeBrush}"
                                BorderThickness="1"
                                CornerRadius="2">
                                <Grid x:Name="_keep_ExpandSite">
                                    <ItemsControl ItemsSource="{Binding ModuleItems}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <UniformGrid Columns="3" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Grid
                                                    x:Name="_ModuleItem_Bg"
                                                    Margin="5"
                                                    PreviewMouseDown="ModuleItem_MouseDown"
                                                    PreviewMouseUp="ModuleItem_MouseUp">
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="50" />
                                                        <RowDefinition Height="20" />
                                                    </Grid.RowDefinitions>
                                                    <Path
                                                        x:Name="_ModuleItem_Path"
                                                        Grid.Row="0"
                                                        Width="30"
                                                        Height="30"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        Data="{Binding Icon}"
                                                        Fill="{DynamicResource DefaultForeground}"
                                                        Stretch="Fill" />
                                                    <TextBlock
                                                        x:Name="_ModuleItem_Text"
                                                        Grid.Row="1"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        FontSize="12"
                                                        Text="{Binding Name}" />
                                                </Grid>
                                                <DataTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="_ModuleItem_Bg" Property="Background" Value="Gray" />
                                                        <Setter TargetName="_ModuleItem_Path" Property="Fill" Value="{DynamicResource OrangeBrush}" />
                                                        <Setter TargetName="_ModuleItem_Text" Property="Foreground" Value="{DynamicResource OrangeBrush}" />
                                                        <Setter Property="Cursor" Value="SizeAll" />
                                                    </Trigger>
                                                </DataTemplate.Triggers>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Grid>
                            </Border>
                        </Popup>
                    </Grid>
                </Grid>
                <DataTemplate.Triggers>
                    <MultiTrigger>
                        <MultiTrigger.Conditions>
                            <Condition Property="IsMouseOver" Value="True" />
                            <Condition SourceName="_keep" Property="Visibility" Value="Visible" />
                        </MultiTrigger.Conditions>
                        <Setter TargetName="_keep_path" Property="Fill" Value="{DynamicResource OrangeBrush}" />
                        <Setter TargetName="_keep" Property="Background" Value="Gray" />
                    </MultiTrigger>

                    <DataTrigger Binding="{Binding IsExpanded, UpdateSourceTrigger=PropertyChanged}" Value="True">
                        <Setter TargetName="ExpandSite" Property="Visibility" Value="Visible" />
                        <Setter TargetName="_path" Property="Data" Value="{DynamicResource 向上}" />
                    </DataTrigger>
                    <DataTrigger Binding="{Binding IsExpanded, UpdateSourceTrigger=PropertyChanged}" Value="False">
                        <Setter TargetName="ExpandSite" Property="Visibility" Value="Collapsed" />
                        <Setter TargetName="_path" Property="Data" Value="{DynamicResource 向右}" />
                    </DataTrigger>
                    <DataTrigger Binding="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType=UserControl}, UpdateSourceTrigger=PropertyChanged}" Value="True">
                        <Setter TargetName="_folded" Property="Visibility" Value="Visible" />
                        <Setter TargetName="_keep" Property="Visibility" Value="Collapsed" />
                        <Setter TargetName="_item_border" Property="Visibility" Value="Visible" />
                        <Setter TargetName="_item_grid" Property="MinWidth" Value="250" />
                    </DataTrigger>
                    <DataTrigger Binding="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType=UserControl}, UpdateSourceTrigger=PropertyChanged}" Value="False">
                        <Setter TargetName="_folded" Property="Visibility" Value="Collapsed" />
                        <Setter TargetName="_keep" Property="Visibility" Value="Visible" />
                        <Setter TargetName="_item_border" Property="Visibility" Value="Hidden" />
                        <Setter TargetName="_item_grid" Property="MinWidth" Value="50" />
                    </DataTrigger>
                </DataTemplate.Triggers>
            </DataTemplate>
        </ItemsControl.ItemTemplate>
    </ItemsControl>
</UserControl>
